{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 23, "column": 0}, "map": {"version":3,"sources":["turbopack://[project]/src/middleware.ts"],"sourcesContent":["import { HttpTypes } from \"@medusajs/types\"\nimport { NextRequest, NextResponse } from \"next/server\"\n\nconst BACKEND_URL = process.env.MEDUSA_BACKEND_URL\nconst PUBLISHABLE_API_KEY = process.env.NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY\nconst DEFAULT_REGION = process.env.NEXT_PUBLIC_DEFAULT_REGION || \"us\"\n\nconst regionMapCache = {\n  regionMap: new Map<string, HttpTypes.StoreRegion>(),\n  regionMapUpdated: Date.now(),\n}\n\nasync function getRegionMap(cacheId: string) {\n  const { regionMap, regionMapUpdated } = regionMapCache\n\n  if (!BACKEND_URL) {\n    throw new Error(\n      \"Middleware.ts: Error fetching regions. Did you set up regions in your Medusa Admin and define a MEDUSA_BACKEND_URL environment variable? Note that the variable is no longer named NEXT_PUBLIC_MEDUSA_BACKEND_URL.\"\n    )\n  }\n\n  if (\n    !regionMap.keys().next().value ||\n    regionMapUpdated < Date.now() - 3600 * 1000\n  ) {\n    // Fetch regions from Medusa. We can't use the JS client here because middleware is running on Edge and the client needs a Node environment.\n    const { regions } = await fetch(`${BACKEND_URL}/store/regions`, {\n      headers: {\n        \"x-publishable-api-key\": PUBLISHABLE_API_KEY!,\n      },\n      next: {\n        revalidate: 3600,\n        tags: [`regions-${cacheId}`],\n      },\n      cache: \"force-cache\",\n    }).then(async (response) => {\n      const json = await response.json()\n\n      if (!response.ok) {\n        throw new Error(json.message)\n      }\n\n      return json\n    })\n\n    if (!regions?.length) {\n      throw new Error(\n        \"No regions found. Please set up regions in your Medusa Admin.\"\n      )\n    }\n\n    // Create a map of country codes to regions.\n    regions.forEach((region: HttpTypes.StoreRegion) => {\n      region.countries?.forEach((c) => {\n        regionMapCache.regionMap.set(c.iso_2 ?? \"\", region)\n      })\n    })\n\n    regionMapCache.regionMapUpdated = Date.now()\n  }\n\n  return regionMapCache.regionMap\n}\n\nasync function getCountryCode(\n  request: NextRequest,\n  regionMap: Map<string, HttpTypes.StoreRegion | number>\n) {\n  try {\n    let countryCode\n\n    const vercelCountryCode = request.headers\n      .get(\"x-vercel-ip-country\")\n      ?.toLowerCase()\n\n    const urlCountryCode = request.nextUrl.pathname.split(\"/\")[1]?.toLowerCase()\n\n    if (urlCountryCode && regionMap.has(urlCountryCode)) {\n      countryCode = urlCountryCode\n    } else if (vercelCountryCode && regionMap.has(vercelCountryCode)) {\n      countryCode = vercelCountryCode\n    } else if (regionMap.has(DEFAULT_REGION)) {\n      countryCode = DEFAULT_REGION\n    } else if (regionMap.keys().next().value) {\n      countryCode = regionMap.keys().next().value\n    }\n\n    return countryCode\n  } catch (error) {\n    if (process.env.NODE_ENV === \"development\") {\n      console.error(\n        \"Middleware.ts: Error getting the country code. Did you set up regions in your Medusa Admin and define a MEDUSA_BACKEND_URL environment variable? Note that the variable is no longer named NEXT_PUBLIC_MEDUSA_BACKEND_URL.\"\n      )\n    }\n  }\n}\n\nexport async function middleware(request: NextRequest) {\n  // Short-circuit static assets\n  if (request.nextUrl.pathname.includes(\".\")) {\n    return NextResponse.next()\n  }\n\n  const cacheIdCookie = request.cookies.get(\"_medusa_cache_id\")\n  const urlSegment = request.nextUrl.pathname.split(\"/\")[1]\n  const looksLikeLocale = /^[a-z]{2}$/i.test(urlSegment || \"\")\n\n  // Fast path: URL already has a locale segment and cache cookie exists\n  if (looksLikeLocale && cacheIdCookie) {\n    return NextResponse.next()\n  }\n\n  let response = NextResponse.next()\n\n  // Ensure cache id cookie exists (set without redirect)\n  const cacheId = cacheIdCookie?.value || crypto.randomUUID()\n  if (!cacheIdCookie) {\n    response.cookies.set(\"_medusa_cache_id\", cacheId, {\n      maxAge: 60 * 60 * 24,\n    })\n  }\n\n  const regionMap = await getRegionMap(cacheId)\n  const countryCode = regionMap && (await getCountryCode(request, regionMap))\n\n  const urlHasCountryCode =\n    countryCode && request.nextUrl.pathname.split(\"/\")[1].includes(countryCode)\n\n  // If no country code in URL but we can resolve one, redirect to locale-prefixed path\n  if (!urlHasCountryCode && countryCode) {\n    const redirectPath =\n      request.nextUrl.pathname === \"/\" ? \"\" : request.nextUrl.pathname\n    const queryString = request.nextUrl.search ? request.nextUrl.search : \"\"\n    const redirectUrl = `${request.nextUrl.origin}/${countryCode}${redirectPath}${queryString}`\n    return NextResponse.redirect(redirectUrl, 307)\n  }\n\n  return response\n}\n\nexport const config = {\n  matcher: [\n    \"/((?!api|_next/static|_next/image|favicon.ico|images|assets|png|svg|jpg|jpeg|gif|webp).*)\",\n  ],\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 133, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}}]
}