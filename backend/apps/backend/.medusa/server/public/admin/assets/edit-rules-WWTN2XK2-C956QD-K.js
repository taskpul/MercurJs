import{R as _}from"./chunk-Q7YRCENL-2s-GK8aF.js";import{ac as E,b as v,dN as q,j as r,H as S,dI as A,dO as B,dP as C,dQ as z,r as D,aw as H,ax as N,ay as s,B as R,aR as p}from"./index-DWDHrirZ.js";import"./chunk-GZBFGV7Y-lbEB6NJG.js";import{K as U}from"./chunk-6HTZNHPT-BN1Yanla.js";import{b as c,u as I}from"./chunk-4TC5YS65-oIm_9E30.js";import"./chunk-HFB3OQXI-Ci46Yn2d.js";var K=s.object({type:s.string().optional(),rules:s.array(s.object({id:s.string().optional(),attribute:s.string().min(1,{message:p.t("promotions.form.required")}),operator:s.string().min(1,{message:p.t("promotions.form.required")}),values:s.union([s.number().min(1,{message:p.t("promotions.form.required")}),s.string().min(1,{message:p.t("promotions.form.required")}),s.array(s.string()).min(1,{message:p.t("promotions.form.required")})]),required:s.boolean().optional(),disguised:s.boolean().optional(),field_type:s.string().optional()}))}),L=({promotion:t,ruleType:f,handleSubmit:l,isSubmitting:i})=>{const{t:d}=v(),[n,a]=D.useState([]),u=H({defaultValues:{rules:[],type:t.type},resolver:N(K)}),m=u.handleSubmit(l(n));return r.jsx(c.Form,{form:u,children:r.jsxs(U,{onSubmit:m,className:"flex h-full flex-col",children:[r.jsx(c.Body,{children:r.jsx(_,{form:u,ruleType:f,setRulesToRemove:a,rulesToRemove:n,promotion:t})}),r.jsx(c.Footer,{children:r.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[r.jsx(c.Close,{asChild:!0,children:r.jsx(R,{size:"small",variant:"secondary",disabled:i,children:d("actions.cancel")})}),r.jsx(R,{size:"small",type:"submit",isLoading:i,children:d("actions.save")})]})})]})})},M=t=>t.field_type==="number"?parseInt(t.values):t.values,O=({promotion:t,rules:f,ruleType:l})=>{const{handleSuccess:i}=I(),{mutateAsync:d}=A(t.id),{mutateAsync:n}=B(t.id,l),{mutateAsync:a}=C(t.id,l),{mutateAsync:u,isPending:m}=z(t.id,l),b=o=>async function(g){const h={},{rules:x=[]}=g,w=x.filter(e=>e.disguised),F=(o==null?void 0:o.filter(e=>e.disguised))||[];for(const e of w)h[e.attribute]=M(e);for(const e of F)h[e.attribute]=null;const y=x.filter(e=>!e.disguised),j=y.filter(e=>!("id"in e)),P=y.filter(e=>typeof e.id=="string");Object.keys(h).length&&await d({application_method:h}),j.length&&await n({rules:j.map(e=>({attribute:e.attribute,operator:e.operator,values:e.values}))}),o!=null&&o.length&&await a({rule_ids:o.map(e=>e.id).filter(Boolean)}),P.length&&await u({rules:P.map(e=>({id:e.id,attribute:e.attribute,operator:e.operator,values:e.values}))}),i()};return r.jsx(L,{promotion:t,rules:f,ruleType:l,handleSubmit:b,isSubmitting:m})},J=()=>{var o,g;const t=E();if(!["rules","buy-rules","target-rules"].includes(t.ruleType))throw"invalid page";const{t:l}=v(),i=t.ruleType,d=t.id,n=[],{promotion:a,isPending:u,isError:m,error:b}=q(d);if(a&&(i==="rules"?n.push(...a.rules||[]):i==="target-rules"?n.push(...((o=a==null?void 0:a.application_method)==null?void 0:o.target_rules)||[]):i==="buy-rules"&&n.push(...((g=a.application_method)==null?void 0:g.buy_rules)||[])),m)throw b;return r.jsxs(c,{children:[r.jsx(c.Header,{children:r.jsx(S,{children:l(`promotions.edit.${i}.title`)})}),!u&&a&&r.jsx(O,{promotion:a,rules:n,ruleType:i})]})};export{J as Component};
