import{E as X,U as Y}from"./chunk-PYOW3HT5-VilTLX4d.js";import"./chunk-ZQRKUG6J-BZ83ACZ9.js";import{b as P,ac as Z,ab as ee,j as e,ao as se,r as j,aw as te,ax as ae,z as ie,E as re,G,J as ne,K as le,M as oe,af as W,s as de,t as K,B as I,L as B,N as ce,S as ue,aO as he,Q as me,R as fe,ah as T,c as xe,g as pe,W as D,T as ge,aP as be,a2 as je,a4 as ve,a5 as ye,$ as z,ag as H,Z as q,_ as O,aQ as we,aL as Te}from"./index-DWDHrirZ.js";import{K as Ne}from"./chunk-6HTZNHPT-BN1Yanla.js";import{R as v,u as Ce}from"./chunk-4TC5YS65-oIm_9E30.js";import{T as F}from"./thumbnail-badge-CFvfGejl.js";import"./chunk-TYTNUPXB-BFzHQ2aB.js";import"./chunk-6GU6IDUA-CDc7wW5L.js";var Se=({product:s})=>{const[t,i]=j.useState({}),{t:a}=P(),{handleSuccess:o}=Ce(),m=te({defaultValues:{media:ke(s.images,s.thumbnail)},resolver:ae(X)}),{fields:l,append:r,remove:d,update:g}=ie({name:"media",control:m.control,keyName:"field_id"}),[h,p]=j.useState(null),C=re(G(oe),G(le,{coordinateGetter:ne})),y=n=>{p(n.active.id)},M=n=>{p(null);const{active:x,over:u}=n;if(x.id!==(u==null?void 0:u.id)){const b=l.findIndex(N=>N.field_id===x.id),A=l.findIndex(N=>N.field_id===(u==null?void 0:u.id));m.setValue("media",je(l,b,A),{shouldDirty:!0,shouldTouch:!0})}},c=()=>{p(null)},{mutateAsync:S,isPending:_}=W(s.id),E=m.handleSubmit(async({media:n})=>{var N;const x=n.map((f,k)=>({file:f.file,index:k})).filter(f=>!!f.file);let u=[];if(x.length){const{files:f}=await de.admin.upload.create({files:x.map(k=>k.file)}).catch(()=>(m.setError("media",{type:"invalid_file",message:a("products.media.failedToUpload")}),{files:[]}));u=f}const b=n.map((f,k)=>{var U;const R=x.findIndex(J=>J.index===k);return R>-1?{...f,url:(U=u[R])==null?void 0:U.url}:f}),A=(N=b.find(f=>f.isThumbnail))==null?void 0:N.url;await S({images:b.map(f=>({url:f.url,id:f.id})),thumbnail:A||null},{onSuccess:()=>{K.success(a("products.media.successToast")),o()},onError:f=>{K.error(f.message)}})}),w=j.useCallback(n=>x=>{if(x)i(u=>({...u,[n]:!0}));else{const{[n]:u,...b}=t;i(b)}},[t]),Q=()=>{const x=Object.keys(t).map(u=>l.findIndex(b=>b.id===u));d(x),i({})},$=()=>{const n=Object.keys(t);if(!n.length)return;const x=l.findIndex(b=>b.isThumbnail);x>-1&&g(x,{...l[x],isThumbnail:!1});const u=l.findIndex(b=>b.id===n[0]);g(u,{...l[u],isThumbnail:!0}),i({})},L=Object.keys(t).length;return e.jsx(v.Form,{blockSearchParams:!0,form:m,children:e.jsxs(Ne,{className:"flex size-full flex-col overflow-hidden",onSubmit:E,children:[e.jsx(v.Header,{children:e.jsx("div",{className:"flex items-center justify-end gap-x-2",children:e.jsx(I,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(B,{to:{pathname:".",search:void 0},children:a("products.media.galleryLabel")})})})}),e.jsx(v.Body,{className:"flex flex-col overflow-hidden",children:e.jsxs("div",{className:"flex size-full flex-col-reverse lg:grid lg:grid-cols-[1fr_560px]",children:[e.jsx(ce,{sensors:C,onDragEnd:M,onDragStart:y,onDragCancel:c,children:e.jsx("div",{className:"bg-ui-bg-subtle size-full overflow-auto",children:e.jsxs("div",{className:"grid h-fit auto-rows-auto grid-cols-4 gap-6 p-6",children:[e.jsx(ue,{items:l.map(n=>n.field_id),strategy:he,children:l.map(n=>e.jsx(ze,{onCheckedChange:w(n.id),checked:!!t[n.id],media:n},n.field_id))}),e.jsx(me,{dropAnimation:Ie,children:h?e.jsx(Pe,{media:l.find(n=>n.field_id===h),checked:!!t[l.find(n=>n.field_id===h).id]}):null})]})})}),e.jsx("div",{className:"bg-ui-bg-base overflow-auto border-b px-6 py-4 lg:border-b-0 lg:border-l",children:e.jsx(Y,{form:m,append:r})})]})}),e.jsx(T,{open:!!L,children:e.jsxs(T.Bar,{children:[e.jsx(T.Value,{children:a("general.countSelected",{count:L})}),e.jsx(T.Seperator,{}),L===1&&e.jsxs(j.Fragment,{children:[e.jsx(T.Command,{action:$,label:a("products.media.makeThumbnail"),shortcut:"t"}),e.jsx(T.Seperator,{})]}),e.jsx(T.Command,{action:Q,label:a("actions.delete"),shortcut:"d"})]})}),e.jsx(v.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(v.Close,{asChild:!0,children:e.jsx(I,{variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(I,{size:"small",type:"submit",isLoading:_,children:a("actions.save")})]})})]})})},ke=(s,t)=>{const i=(s==null?void 0:s.map(a=>({id:a.id,url:a.url,isThumbnail:a.url===t,file:null})))||[];if(t&&!i.some(a=>a.url===t)){const a=Math.random().toString(36).substring(7);i.unshift({id:a,url:t,isThumbnail:!0,file:null})}return i},Ie={sideEffects:fe({styles:{active:{opacity:"0.4"}}})},ze=({media:s,checked:t,onCheckedChange:i})=>{const{t:a}=P(),o=j.useCallback(y=>{i(y)},[i]),{attributes:m,listeners:l,setNodeRef:r,setActivatorNodeRef:d,transform:g,transition:h,isDragging:p}=ve({id:s.field_id}),C={opacity:p?.4:void 0,transform:ye.Transform.toString(g),transition:h};return e.jsxs("div",{className:z("shadow-elevation-card-rest hover:shadow-elevation-card-hover focus-visible:shadow-borders-focus bg-ui-bg-subtle-hover group relative aspect-square h-auto max-w-full overflow-hidden rounded-lg outline-none"),style:C,ref:r,children:[s.isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(H,{content:a("products.media.thumbnailTooltip"),children:e.jsx(F,{})})}),e.jsx("div",{className:z("absolute inset-0 cursor-grab touch-none outline-none",{"cursor-grabbing":p}),ref:d,...m,...l}),e.jsx("div",{className:z("transition-fg absolute right-2 top-2 opacity-0",{"group-focus-within:opacity-100 group-hover:opacity-100 group-focus:opacity-100":!p&&!t,"opacity-100":t}),children:e.jsx(q,{onClick:y=>{y.stopPropagation()},checked:t,onCheckedChange:o})}),e.jsx("img",{src:s.url,alt:"",className:"size-full object-cover object-center"})]})},Pe=({media:s,checked:t})=>e.jsxs("div",{className:"shadow-elevation-card-rest hover:shadow-elevation-card-hover focus-visible:shadow-borders-focus bg-ui-bg-subtle-hover group relative aspect-square h-auto max-w-full cursor-grabbing overflow-hidden rounded-lg outline-none",children:[s.isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(F,{})}),e.jsx("div",{className:z("transition-fg absolute right-2 top-2 opacity-0",{"opacity-100":t}),children:e.jsx(q,{checked:t})}),e.jsx("img",{src:s.url,alt:"",className:"size-full object-cover object-center"})]}),Me=({product:s})=>{const{state:t}=xe(),[i,a]=j.useState((t==null?void 0:t.curr)||0),{t:o}=P(),m=pe(),{mutateAsync:l,isPending:r}=W(s.id),d=_e(s.images,s.thumbnail),g=j.useCallback(()=>{r||a(c=>(c+1)%d.length)},[d,r]),h=j.useCallback(()=>{r||a(c=>(c-1+d.length)%d.length)},[d,r]),p=j.useCallback(c=>{r||a(c)},[r]),C=()=>{if(r)return;const c=document.createElement("a");c.href=d[i].url,c.download="image",c.target="_blank",c.click()},y=async()=>{var E;const c=d[i];if(!await m({title:o("general.areYouSure"),description:c.isThumbnail?o("products.media.deleteWarningWithThumbnail",{count:1}):o("products.media.deleteWarning",{count:1}),confirmText:o("actions.delete"),cancelText:o("actions.cancel")}))return;const _=((E=s.images)==null?void 0:E.filter(w=>w.id!==c.id).map(w=>({url:w.url})))||[];i===d.length-1&&a(w=>w-1),await l({images:_,thumbnail:c.isThumbnail?"":void 0})};j.useEffect(()=>{const c=S=>{S.key==="ArrowRight"?g():S.key==="ArrowLeft"&&h()};return document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}},[g,h]);const M=!d.length;return e.jsxs("div",{className:"flex size-full flex-col overflow-hidden",children:[e.jsx(v.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsxs(D,{size:"small",type:"button",onClick:y,disabled:M,children:[e.jsx(ge,{}),e.jsx("span",{className:"sr-only",children:o("products.media.deleteImageLabel")})]}),e.jsxs(D,{size:"small",type:"button",onClick:C,disabled:M,children:[e.jsx(be,{}),e.jsx("span",{className:"sr-only",children:o("products.media.downloadImageLabel")})]}),e.jsx(I,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(B,{to:{pathname:".",search:"view=edit"},children:o("actions.edit")})})]})}),e.jsxs(v.Body,{className:"flex flex-col overflow-hidden",children:[e.jsx(Ee,{curr:i,media:d}),e.jsx(De,{curr:i,media:d,prev:h,next:g,goTo:p})]})]})},Ee=({media:s,curr:t})=>{const{t:i}=P();return s.length===0?e.jsxs("div",{className:"bg-ui-bg-subtle flex size-full flex-col items-center justify-center gap-y-4 pb-8 pt-6",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(O,{size:"small",leading:"compact",weight:"plus",className:"text-ui-fg-subtle",children:i("products.media.emptyState.header")}),e.jsx(O,{size:"small",className:"text-ui-fg-muted",children:i("products.media.emptyState.description")})]}),e.jsx(I,{size:"small",variant:"secondary",asChild:!0,children:e.jsx(B,{to:"?view=edit",children:i("products.media.emptyState.action")})})]}):e.jsx("div",{className:"bg-ui-bg-subtle relative size-full overflow-hidden",children:e.jsx("div",{className:"flex size-full items-center justify-center p-6",children:e.jsxs("div",{className:"relative inline-block max-h-full max-w-full",children:[s[t].isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(H,{content:i("products.media.thumbnailTooltip"),children:e.jsx(F,{})})}),e.jsx("img",{src:s[t].url,alt:"",className:"object-fit shadow-elevation-card-rest max-h-[calc(100vh-200px)] w-auto rounded-xl object-contain"})]})})})},V=8,De=({media:s,curr:t,prev:i,next:a,goTo:o})=>{if(!s.length)return null;const l=((r,d)=>{if(r.length<=V)return r;const g=Math.floor(V/2),h=(d-g+r.length)%r.length,p=(h+V)%r.length;return p<h?[...r.slice(h),...r.slice(0,p)]:r.slice(h,p)})(s,t);return e.jsxs("div",{className:"flex shrink-0 items-center justify-center gap-x-2 border-t p-3",children:[e.jsx(D,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:i,children:e.jsx(we,{})}),e.jsx("div",{className:"flex items-center gap-x-2",children:l.map(r=>{const d=r.id===s[t].id,g=s.findIndex(h=>h.id===r.id);return e.jsx("button",{type:"button",onClick:()=>o(g),className:z("transition-fg size-7 overflow-hidden rounded-[4px] outline-none",{"shadow-borders-focus":d}),children:e.jsx("img",{src:r.url,alt:"",className:"size-full object-cover"})},r.id)})}),e.jsx(D,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:a,children:e.jsx(Te,{})})]})},_e=(s,t)=>{const i=(s==null?void 0:s.map(a=>({id:a.id,url:a.url,isThumbnail:a.url===t})))||[];return t&&!i.some(a=>a.isThumbnail)&&i.unshift({id:"thumbnail_only",url:t,isThumbnail:!0}),i},Le=j.createContext(null),Ae=s=>s.get("view")==="edit"?"edit":"gallery",Ve=({product:s})=>{const[t,i]=se(),a=Ae(t),o=m=>()=>{i({view:m})};return e.jsx(Le.Provider,{value:{goToGallery:o("gallery"),goToEdit:o("edit")},children:Be(a,s)})},Be=(s,t)=>{switch(s){case"gallery":return e.jsx(Me,{product:t});case"edit":return e.jsx(Se,{product:t})}},qe=()=>{const{t:s}=P(),{id:t}=Z(),{product:i,isLoading:a,isError:o,error:m}=ee(t),l=!a&&i;if(o)throw m;return e.jsxs(v,{children:[e.jsx(v.Title,{asChild:!0,children:e.jsx("span",{className:"sr-only",children:s("products.media.label")})}),e.jsx(v.Description,{asChild:!0,children:e.jsx("span",{className:"sr-only",children:s("products.media.editHint")})}),l&&e.jsx(Ve,{product:i})]})};export{qe as Component};
